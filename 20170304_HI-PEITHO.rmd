---
title: "Examine distribution of Mann Whitney statistics under non-null distribution"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


This file was created `r date()`.

## Purpose
- Determine distribution of Mann Whitney statistics under non-null distribution using formula from paper by
Matsouaka and Betensky (Stat Med 2014, DOI: 10.1002/sim.6355)
- Simulate for settings relevant for HI-PEITHO

## Theoretical considerations
### Determining E(U) and var(U) according to the formula from Matsouaka and Betensky
#### Notation
#### General
Symbol               | Description
-------------------- | ---------------------------------------------------------------------------
$i=0,1$              | denotes group, $i=0$ denotes reference group, $i=1$ denotes treatment group
$n_i$                | sample size group in $i$
$n = n_0 + n_1$      | total sample size
$\tau$               | time at which quantitative endpoint is determined

#### Survival endpoint
Assuming exponential distributions for times to event.

Symbol          | Description
--------------- | --------------------------------------------------------------------------
$t_{0k}$        | time to event for k-th individal in reference group
$t_{1l}$        | time to event for l-th individal in treatment group
$f_{i}(t)$      | probability density function of time to event random variable in group $i$
$F_{i}(t)$      | distribution function of time to event random variable in group $i$
$S_{i}(t)$      | survivor function of time to event random variable in group $i$
$p_i$           | mortality in group $i$ at time $\tau$
$q_i= 1 - p_i$  | survival probability in group $i$ at time $\tau$
$d_{0k}$        | event indicator for k-th individal in reference group, i.e. $d_{0k}=1$ if $t_{0k} < \tau$, 0 otherwise
$d_{1l}$        | event indicator for l-th individal in treatment group, i.e. $d_{1l}=1$ if $t_{1l} < \tau$, 0 otherwise
$\lambda_i=\frac{-\log(q_i)}{\tau}$       | hazard in group $i$
$\mathit{HR}=\frac{\lambda_1}{\lambda_0}$ | hazard ratio

From these definitions it follows that $p_i = P(d_{ik} = 1) = P(t_{ik} < \tau)= F_i(\tau), q_i = S_i(\tau), i=0, 1$.

#### Quantitative endpoint
Assuming normal distributions with common variance for quantitative endpoint.

Symbol        | Description
------------- | -----------------------------------------------------------------------------------------
$x_{0k}$      | value of quantitative endpoint for k-th individal in reference group
$x_{1l}$      | value of quantitative endpoint for l-th individal in treatment group
$g_{i}(x)$    | probability density function of  qantitative endpoint in group $i$
$G_{i}(x)$    | distribution function of qantitative endpoint in group $i$
$\varphi(x)$  | probability density function of the standard normal distribution
$\Phi(x)$     | distribution function of the standard normal distribution
$\mu_i$       | mean in group $i$
$\sigma$      | common standard deviation
$\delta = \mu_1 - \mu_0$       | difference between group means
$\frac{\mu_1 - \mu_0}{\sigma}$ | effect size

Matsouaka and Betensky derive a formula for mean and variance for the global rank test statistic U with the definitions for $\tilde{X_{0k}}$ and $\tilde{X_{1l}}$ from the paper.

$U = \frac{1}{n_0 n_1}\sum_{k=1}^{n_0}\sum_{l=1}^{n_1}I(\tilde{X_{0k}} < \tilde{X_{1l}})$

Then expectation and variance are (not just for the case of identical distributions in both groups) given by:

$\mu_U = E(U) = p_0 p_1 \pi_{t1} + p_0 q_1 + q_0 q_1 \pi_{x1} = \pi_{U1}$

$\sigma_U^2 = var(U) = (n_0 n_1)^{-1} (\pi_{U1} (1 - \pi_{U1}) +
                                         (n_0 - 1) (\pi_{U2} - \pi_{U1}^2) + 
                                         (n_1 - 1) (\pi_{U3} - \pi_{U1}^2))$
                                         
where

$\pi_{U1} = p_0 p_1 \pi_{t1} + p_0 q_1 + q_0 q_1 \pi_{x1}$

$\pi_{U2} = p_0^2 q_1 + p_0^2 p_1 \pi_{t2} + 2 p_0 q_0 q_1 \pi_{x1} + q_0^2 q_1 \pi_{x2}$

$\pi_{U3} = p_0 q_1^2 + p_0 p_1^2 \pi_{t3} + 2 p_0 p_1 q_1 \pi_{t1} + q_0 q_1^2 \pi_{x3}$

and

$\pi_{t1} = P(t_{0k} < t_{1l} | d_{0k} = d_{1l} = 1)$

$\pi_{t2} = P(t_{0k} < t_{1l}, t_{0k'} < t_{1l} | d_{0k} = d_{0k'} = d_{1l} = 1)$

$\pi_{t3} = P(t_{0k} < t_{1l}, t_{0k} < t_{1l'} | d_{0k} = d_{1l} = d_{1l'} =1)$

$\pi_{x1} = P(x_{0k} < x_{1l})$

$\pi_{x2} = P(x_{0k} < x_{1l}, x_{0k'} < x_{1l})$

$\pi_{x3} = P(x_{0k} < x_{1l}, x_{0k} < x_{1l'})$

Express $\pi_{t1}$, $\pi_{t2}$ and $\pi_{t3}$ in terms of the pdf, cdf, $p_0$, and $p_1$:

\begin{eqnarray*}
  \pi_{t1} & = & \frac{P(t_{0k} < t_{1l} < \tau)}{P(t_{0k} < \tau)P(t_{1l} < \tau)}
= \frac{1}{p_0 p_1}\int_0^\tau f_0(u)\int_u^\tau f_1(v)dv du  \\
& = &  \frac{1}{p_0 p_1}\int_0^\tau f_0(u)\left( F_1(\tau) - F_1(u)\right)du
= \frac{1}{p_0 p_1}\left( p_0 p_1 - \int_0^\tau f_0(u)F_1(u) du \right) \\
\\
\pi_{t2} & = &\frac{P(max(t_{0k}, t_{0k'}) < t_{1l} < \tau)}{P(t_{0k} < \tau)P(t_{0k'} < \tau)P(t_{1l} < \tau)}
  =   \frac{1}{p_0^2 p_1}\int_0^\tau 2f_0(u) F_0(u)\int_u^\tau f_1(v)dv du \\
& = & \frac{1}{p_0^2 p_1}\int_0^\tau 2f_0(u) F_0(u) (F_1(\tau) - F_1(u)) du 
  =   \frac{1}{p_0^2 p_1}\left(p_1 \int_0^\tau 2 f_0(u) F_0(u) du - \int_0^\tau 2 f_0(u) F_0(u) F_1(u) du \right) \\
& = & \frac{1}{p_0^2 p_1}\left(p_1 F_0^2(u)|_0^\tau - F_0^2(u) F_1(u)|_0^\tau + \int_0^\tau F_0^2(u) f_1(u)du) \right)
  =   \frac{1}{p_0^2 p_1}\int_0^\tau F_0^2(u) f_1(u)du) \\
\\
\pi_{t3} & = &\frac{P(t_{0k}  < t_{1l} < t_{1l'} < \tau) + P(t_{0k}  < t_{1l'} < t_{1l} < \tau)}{P(t_{0k} < \tau)P(t_{1l} < \tau)P(t_{1l'} < \tau)}
  =   \frac{2 P(t_{0k}  < t_{1l} < t_{1l'} < \tau)}{P(t_{0k} < \tau)P(t_{1l} < \tau)P(t_{1l'} < \tau)} \\
& = & \frac{2}{p_0 p_1^2}\int_0^\tau f_0(u) \int_u^\tau f_1(v) \int_v^\tau f_1(w) dw dv du
  =   \frac{2}{p_0 p_1^2}\int_0^\tau f_0(u) \int_u^\tau f_1(v) (F_1(\tau) - F_1(v)) dv du \\
& = & \frac{2}{p_0 p_1^2}\int_0^\tau f_0(u) \left(p_1 (F_1(\tau) - F_1(u)) - \frac{1}{2}(F_1^2(\tau) - F_1^2(u)) \right)du \\
& = & \frac{1}{p_0 p_1^2}\left(p_0 p_1^2 - 2 p_1 \int_0^\tau f_0(u) F_1(u) du +  \int_0^\tau f_0(u) F_1^2(u) du \right)
\end{eqnarray*}

Now make use of the fact that $t_{ik} \sim exp(\lambda_i)$, i. e. $f_i(t) = \lambda_i e^{-\lambda_i t}$ and 
$F_i(t) = 1- e^{-\lambda_i t}$.

\begin{eqnarray*} 
\pi_{t1} & = & \frac{1}{p_0 p_1}\left( p_0 p_1 - \int_0^\tau \lambda_0 e^{-\lambda_0 u} (1- e^{-\lambda_1 u})du \right) 
= \frac{1}{p_0 p_1}\left(
                         p_0 p_1 - p_0
                         - \frac{\lambda_0}{\lambda_0 + \lambda_1} ( e^{-(\lambda_0 + \lambda_1)\tau}  - 1)
                   \right) \\
& = & \frac{1}{p_0 p_1}\left( p_0 p_1 - p_0 - \frac{1}{1 + \mathit{HR}} ( q_0 q_1  - 1) \right)
= \frac{1}{p_0 p_1}\left( p_0 p_1 - p_0 - \frac{1}{1 + \mathit{HR}} ( p_0 p_1  - p_0 - p_1)
                   \right) \\
\\
\pi_{t2} & = & \frac{1}{p_0^2 p_1}\int_0^\tau (1 - e^{-\lambda_0 u})^2 \lambda_1 e^{-\lambda_1 u} du
  = \frac{1}{p_0^2 p_1}\left(
                        \int_0^\tau \lambda_1 e^{-\lambda_0 u} du 
                          - 2 \lambda_1 \int_0^\tau \lambda_1 e^{-(\lambda_0 + \lambda_1) u} du
                          + \lambda_1 \int_0^\tau \lambda_1 e^{-(2\lambda_0 + \lambda_1) u} du
                      \right) \\
& = & \frac{1}{p_0^2 p_1}\left(p_1 + \frac{2\lambda_1}{\lambda_0 + \lambda_1} (e^{-(\lambda_0 + \lambda1)\tau} - 1) - \frac{\lambda_1}{2\lambda_0 + \lambda_1} (e^{-(2\lambda_0 + \lambda1)\tau} - 1)
                      \right) \\
                     
& = & \frac{1}{p_0^2 p_1}\left(p_1 + \frac{2\lambda_1}{\lambda_0 + \lambda_1} (q_0 q_1 - 1) - \frac{\lambda_1}{2\lambda_0 + \lambda_1}(q_0^2 q_1 - 1)
                         \right) \\

& = & \frac{1}{p_0^2 p_1}\left(p_1 + \frac{2}{1 + \mathit{HR}} (q_0 q_1 - 1) - \frac{1}{2 + \mathit{HR}}(q_0^2 q_1 - 1)
                      \right) \\
\pi_{t3} & = & \frac{1}{p_0 p_1^2}\left(p_0 p_1^2 - 2 p_1 \int_0^\tau \lambda_0 e^{-\lambda_0 u}(1 - e^{-\lambda_1 u})du + \int_0^\tau \lambda_0 e^{-\lambda_0 u}(1 - e^{-\lambda_1 u})^2du
                                  \right) \\
& = & \frac{1}{p_0 p_1^2}\left(p_0 p_1^2 - 2p_1(p_0 + \frac{\lambda_0}{\lambda_0 + \lambda_1}(e^{-(\lambda_0 + \lambda_1)\tau} - 1)) + (p_0 + \frac{2\lambda_0}{\lambda_0 + \lambda_1}(e^{-(\lambda_0 + \lambda_1)\tau} - 1)
- \frac{\lambda_0}{\lambda_0 + 2\lambda_1}(e^{-(\lambda_0 + 2\lambda_1)\tau}) - 1) 
                         \right) \\
& = & \frac{1}{p_0 p_1^2}\left( p_0 p_1^2 - 2 p_0 p_1 + p_0
+ \frac{2}{1 + \mathit{HR}} (1 - p_1) (q_0 q_1 - 1) - \frac{1}{2 + \mathit{HR}}(q_0 q_1^2 - 1)
                         \right) \\
& = & \frac{1}{p_0 p_1^2}\left( p_0 q_1^2 + \frac{2}{1 + \mathit{HR}}q_1(q_0 q_1 - 1)
- \frac{1}{2 + \mathit{HR}}(q_0 q_1^2 - 1)
                         \right) \\
\end{eqnarray*}

From the above defintions follows $X_{0k} \sim \mathcal{N}(\mu_0, \sigma^2)$, $X_{1l} \sim \mathcal{N}(\mu_1, \sigma^2)$ and $\delta = \mu_1 - \mu_0$ and hence

$Y_{0k}:=\frac{X_{0k} - \mu_0}{\sigma} \sim \mathcal{N}(0, 1)$ and $Y_{1l}:=\frac{X_{1l} - \mu_0}{\sigma} = \frac{X_{il} - \mu_1 + \delta}{\sigma} \sim \mathcal{N}( \frac{\delta}{\sigma}, 1)$


Express $\pi_{x1}$, $\pi_{x2}$ and $\pi_{x3}$ in terms of the pdf, cdf of the standard normal distribution.

\begin{eqnarray*}
\pi_{x1} & = & P(X_{0k} < X_{1l}) = P(Y_{0k} < Y_{1l}) = \int_{-\infty}^{\infty}\varphi(x)P(Y_{1l}<x)dx
= \int_{-\infty}^{\infty}\varphi(x)P(\frac{X_{1l} - \mu_1}{\sigma} < x - \frac{\delta}{\sigma})dx \\
& = & \int_{-\infty}^{\infty}\varphi(x) \Phi(x - \frac{\delta}{\sigma}) dx 
=  \int_{-\infty}^{\infty}\varphi(x + \frac{\delta}{\sigma}) \Phi(x) dx \\
\\
\pi_{x2} & = & P(\max(X_{0k}, X_{0k'}) < X_{1l}) = P(\max(Y_{0k}, Y_{0k'}) < Y_{1l}) \\
& = & \int_{-\infty}^{\infty}\varphi(x + \frac{\delta}{\sigma})\Phi^2(x) dx\\
\pi_{x3} & = & P(X_{0k} < X_{1l} < X_{1l'}) + P(X_{0k} < X_{1l'} < X_{1l}) = 2 P(X_{0k} < X_{1l} < X_{1l'}) \\
\\
& = & 2 \int_{-\infty}^{\infty}\varphi(x) \int_{-\infty}^{x}\varphi(y + \frac{\delta}{\sigma}) \int_{-\infty}^{y}\varphi(z + \frac{\delta}{\sigma})dz dy dx \\
& = & 2 \int_{-\infty}^{\infty}\varphi(x) \int_{-\infty}^{x}\varphi(y + \frac{\delta}{\sigma}) \Phi(y + \frac{\delta}{\sigma}) dy dx \\
& = & \int_{-\infty}^{\infty}\varphi(x) \Phi^2(x + \frac{\delta}{\sigma}) dx
\end{eqnarray*}



Set parameters:
```{r Set parameters}
n_0 <- 48                   # sample size in reference group
n_1 <- 96                   # sample size in treatment group
n <- n_0 + n_1              # total sample size
tau <- 1                    # time tau at which quantitative endpoint is determined
p_0 <- 0.2                  # mortality in reference group at time tau
q_0 <- 1 - p_0              # survival in reference group at time tau
lambda_0 <- -log(q_0) / tau # hazard in reference group
mu_0 <- 0.3                 # expected mean in reference group
sigma <- 0.1                # common variance
epsilon <- 0.05             # non-inferiority margin for quantitative endpoint
HR <- 1                     # hazard ratio
delta_0 <- -epsilon         # mean difference (mu_1 - mu_0) under non-inferiority null hypothesis H0
delta_1 <- 0                # assumed mean difference (mu_1 - mu_0) under (non-inferiority) alternative hypothesis H1

lambda_1 <- HR * lambda_0   # hazard in treatment group
q_1 <- exp(-lambda_1)       # survival in treatment group at time tau
p_1 <- 1 - q_1              # mortality in treatment group at time tau
mu_1 <- mu_0 + delta_0      # mean in treatment group under (non-inferiority) null hypothesis H0
```
### Chosen parameters
#### General
Parameter | Value   | Description
--------  | ------  | --------------------------------------------------
$n_0$     | `r n_0` | sample size in reference group
$n_1$     | `r n_1` | sample size in treatment group 
$n$       | `r n`   | total sample size
$\tau$    | `r tau` | time at which quantitative endpoint is determined


#### Survival endpoint
Assume exponential distribution

Parameter     | Value        | Description
--------      | ------------ | --------------------------------------------------------------------------
$p_0$         | `r p_0`      | mortality in reference group at time $\tau =$ `r tau`
$q_0$         | `r q_0`      | survival in reference group at time $\tau =$ `r tau` (derived from $p_0$)
$\lambda_0$   | `r lambda_0` | hazard in reference group (derived from $p_0$)
$\mathit{HR}$ | `r HR`       | hazard ratio
$\lambda_1$   | `r lambda_1` | hazard in treatment group (derived from $\lambda_0$ and HR)
$p_1$         | `r p_0`      | mortality in treatment group at time $\tau =$ `r tau` (derived from $\lambda_1$)
$q_1$         | `r q_0`      | survival in treatment group at time $\tau =$ `r tau` (derived from $p_1$)

#### Quantitative endpoint
Assume normal distribution with common variance

Parameter     | Value        | Description
--------      | ------------ | --------------------------------------------------------------------------
$\mu_0$       | `r mu_0 `    | expected mean in reference group
$\mu_1$       | `r mu_1 `    | mean in treatment group 
$\sigma$      | `r sigma `   | common standard deviation
$\varepsilon$ | `r epsilon ` | non-inferiority margin 
$\delta_0$    | `r delta_0 ` | difference between group means under null hypothesis
$\frac{\mu_1 - \mu_0}{\sigma}$ | `r delta_0/sigma ` | effect size unter null hypothesis
$\delta_1$    | `r delta_1 ` | assumed mean difference  ($\mu_1 - \mu_0$) under (non-inferiority) alternative hypothesis

```{r}
# group indicator
g <- rep(0:1, c(n_0, n_1))

# Generate random samples
set.seed(123)
# 1. Survival endpoint (only if there is mortality)
if (p_0 > 0) {
  t_0 <- -log(runif(n_0, 0, 1)) / lambda_0
  t_1 <- -log(runif(n_1, 0, 1)) / lambda_1
  t <- c(t_0, t_1)
}
# 2. Quantitave endpoint
x_0 <- rnorm(n_0, mean = mu_0, sd = sigma)
x_1 <- rnorm(n_1, mean = mu_1, sd = sigma)
x <- c(x_0, x_1)

# 3. Combine endpoints into untied worst-rank adjusted values: y
eta <- min(x, na.rm = TRUE) - 1 - tau
y <- ifelse(t <= tau, eta + t, x) 
# compute rank sums and U statistics 
ranks <- rank(y)
R_0 <- sum(ranks[g == 0])
R_1 <- sum(ranks[g == 1])
U_0 <- R_0 - n_0 * (n_0 + 1) / 2
U_1 <- R_1 - n_1 * (n_0 + 1) / 2

# 4. Determine expectation and variance of U_0
# mu_u = E(U) = p_0 * p_1 * pi_t1 + p_0 * q_1 + q_0 * q_1 * pi_x1 = pi_U1
# sigma_u = var(U) = (n_0 * n_1)^(-1) * [pi_U1 * (1 - pi_U1) + 
#                                        (n0 - 1) * (pi_U2 - pi_U1^2) +
#                                        (n1 - 1) * (pi_U3 - pi_U1^2)] 
# where 
# pi_U2 = p_0^2 * q_1
# p_1 * pi_t1 + p

# 
#   # identify indices relating to events (i.e. tau <= 1)
#   event_BOOLEAN <- t <= 1                 # vector of length n which indicates (TRUE/FALSE) whether events has occured up to time tau=1
#   events <- which(event_BOOLEAN == TRUE)  # vector containing the indices j of t for which t[j] <= 1 (length = # events)
#   # number of events
#   n_events <- length(events)
#   # rank event times
#   t_rank <- rank(t[events])
#   # compute rank sums for groups 
#   rank_sum_t_0 <- sum(t_rank[g[events] == 0])
#   rank_sum_t_1 <- sum(t_rank[g[events] == 1])
# }else{
#   n_events <- 0
#   event_BOOLEAN <- rep(FALSE, n)
# }
# 
# # identify indices for which quantitative endpoint is observed (i.e. no terminal event)
# no_events <- which(event_BOOLEAN == FALSE) # vector containing the indices j of X for which t[j] > 1, i.e. quantitative endpoint is observed
# # rank quantitative endpoint and add number of events to ranks within observable x-values
# x_rank <- rank(x[no_events]) + n_events
# rank_sum_x_0 <- sum(x_rank[g[no_events] == 0])
# rank_sum_x_1 <- sum(x_rank[g[no_events] == 1])
# 
# # Observations with events up to time tau=1
# # t_0[t_0 <= 1]
# # t_1[t_1 <= 1]

```
